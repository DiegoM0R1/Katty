<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Para Katty de tu Cholasho‚ù§Ô∏è - Versi√≥n 3D</title>
    <style>
        /* Estilos existentes (mantener igual) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
            color: white;
            background: #000;
        }
        
        canvas {
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1;
        }
        
        /* Resto de estilos existentes... */
        
        /* Estilos mejorados para controles m√≥viles */
        .mobile-controls {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40vh;
            z-index: 900;
            touch-action: none;
            pointer-events: auto;
        }
        
        .joystick-container {
            position: absolute;
            bottom: 40px;
            left: 40px;
            width: 120px;
            height: 120px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.5);
            pointer-events: auto;
        }
        
        .joystick-base {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            border: 2px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }
        
        .joystick-thumb {
            width: 60px;
            height: 60px;
            background: rgba(255, 79, 87, 0.8);
            border-radius: 50%;
            position: relative;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.5);
            pointer-events: none;
        }
        
        .mobile-buttons {
            position: absolute;
            bottom: 40px;
            right: 40px;
            display: flex;
            gap: 20px;
        }
        
        .mobile-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(255, 79, 87, 0.8);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            pointer-events: auto;
        }
        
        .mobile-btn:active {
            transform: scale(0.9);
        }
        
        .mobile-controls-hint {
            position: fixed;
            top: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            font-size: 16px;
            z-index: 1000;
            display: none;
            backdrop-filter: blur(5px);
        }
        
        /* Responsividad para m√≥viles */
        @media (max-width: 768px), (pointer: coarse) {
            .controls-hint {
                display: none !important;
            }
            
            .screen-controls {
                display: none !important;
            }
            
            .mobile-controls {
                display: block !important;
            }
            
            .mobile-controls-hint {
                display: block !important;
            }
        }
    </style>
</head>
<body>
    <!-- Estructura HTML existente (mantener igual) -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-heart">‚ù§Ô∏è</div>
        <div class="loading-text">Cargando nuestro mundo...</div>
    </div>
    
    <div class="controls-hint">Usa el rat√≥n para mirar alrededor y las teclas WASD para moverte</div>
    
    <div id="screenControls" class="screen-controls">
        <button id="toggleScreen" class="control-btn">
            <span class="btn-icon">üíå</span>
            <span class="btn-text">Mostrar Mensaje</span>
        </button>
        <button id="toggleMusic" class="control-btn">
            <span class="btn-icon">üéµ</span>
            <span class="btn-text">M√∫sica</span>
        </button>
    </div>

    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <p>Amooooooooor e construido este mundito para ti<3</p>
        </div>
    </div>

    <!-- Agregamos expl√≠citamente los controles m√≥viles -->
    <div id="mobile-controls" class="mobile-controls">
        <div class="joystick-container">
            <div id="joystick-base" class="joystick-base">
                <div id="joystick-thumb" class="joystick-thumb"></div>
            </div>
        </div>
        <div class="mobile-buttons">
            <button id="mobile-message" class="mobile-btn">
                <span class="mobile-btn-icon">üíå</span>
            </button>
            <button id="mobile-music" class="mobile-btn">
                <span class="mobile-btn-icon">üéµ</span>
            </button>
        </div>
    </div>
    
    <div class="mobile-controls-hint">
        Usa el joystick para moverte y arrastra la pantalla para mirar alrededor
    </div>

    <audio id="audioPlayer" src="Daft Punk - Touch (Choral Version from Epilogue - Extended).mp3" preload="auto" style="display:none"></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.min.js"></script>
    <script>
        // Mejor detecci√≥n de dispositivos m√≥viles
        function isMobileDevice() {
            // Comprobaci√≥n espec√≠fica para iOS
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                         (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            
            // Comprobaci√≥n general para otros dispositivos m√≥viles
            const isOtherMobile = /Android|webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            // Tambi√©n detectar por tipo de entrada (touch)
            const hasCoarsePointer = window.matchMedia('(pointer: coarse)').matches;
            
            return isIOS || isOtherMobile || hasCoarsePointer;
        }
        
        // Definir la variable global para usarla en el resto del c√≥digo
        const isMobile = isMobileDevice();
        
        // Variables principales
        let scene, camera, renderer, composer;
        let sun, palmGroup, flowerField, cat, hearts = [];
        let clock = new THREE.Clock();
        const loader = new THREE.TextureLoader();
        
        // Variables para el control t√°ctil
        let touchStartX = 0;
        let touchStartY = 0;
        let touchMoveX = 0;
        let touchMoveY = 0;
        let isTouching = false;
        
        // Variables para el joystick
        let joystickBase, joystickThumb;
        let joystickActive = false;
        let joystickPosition = { x: 0, y: 0 };
        let joystickBaseRect = null;
        
        // Manejo de audio con un efecto de fade in
        function setupAudio() {
            const audioElement = document.getElementById('audioPlayer');
            // Usamos la ruta original del archivo
            audioElement.loop = true;
            audioElement.volume = 0;
            
            // Hacemos un fade in del volumen
            let vol = 0;
            const intervalId = setInterval(() => {
                if (vol < 0.5) {
                    vol += 0.01;
                    audioElement.volume = vol;
                } else {
                    clearInterval(intervalId);
                }
            }, 100);
            
            // Marcamos que la m√∫sica est√° reproduci√©ndose
            isMusicPlaying = true;
            const musicBtn = document.getElementById('toggleMusic');
            if (musicBtn) {
                musicBtn.classList.add('music-active');
                musicBtn.querySelector('.btn-text').textContent = 'Pausar';
                musicBtn.querySelector('.btn-icon').textContent = '‚ô´';
            }
        }
        
        // Inicializar la escena
        function init() {
            // Crear escena
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0xff7e57, 0.02);
            
            // Configurar c√°mara
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 20);
            camera.lookAt(0, 5, 0);
            
            // Configurar renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.outputEncoding = THREE.sRGBEncoding;
            document.body.appendChild(renderer.domElement);
            
            // A√±adir luz ambiental para iluminaci√≥n general
            const ambientLight = new THREE.AmbientLight(0xffd4b3, 0.5);
            scene.add(ambientLight);
            
            // Crear elementos de la escena
            createSkybox();
            createSun();
            createGround();
            createPalms();
            createFlowers();
            createCat();
            createParticles();
            createDigitalScreen();
            
            // Configurar eventos y controles
            if (isMobile) {
                setupMobileControls();
            } else {
                setupDesktopControls();
            }
            
            setupScreenControls();
            window.addEventListener('resize', onWindowResize);
            
            // Ocultar la pantalla de carga despu√©s de inicializar todo
            setTimeout(() => {
                document.getElementById('loadingScreen').style.opacity = 0;
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('myModal').style.display = 'block';
                }, 1000);
            }, 1500);
            
            // Iniciar la animaci√≥n
            animate();
        }
        
        // Funciones existentes (mantener igual)
        // createSkybox, createSun, createGround, createPalms, createFlowers, createCat, createParticles
        // No se incluyen para brevedad, mantener como en el original
        
        // Configuraci√≥n mejorada de controles m√≥viles
        function setupMobileControls() {
            console.log("Configurando controles m√≥viles");
            
            // Mostrar los elementos de control m√≥vil
            document.getElementById('mobile-controls').style.display = 'block';
            document.querySelector('.mobile-controls-hint').style.display = 'block';
            
            // Ocultar controles de escritorio
            document.querySelector('.controls-hint').style.display = 'none';
            document.getElementById('screenControls').style.display = 'none';
            
            // Obtener referencias a los elementos del joystick
            joystickBase = document.getElementById('joystick-base');
            joystickThumb = document.getElementById('joystick-thumb');
            
            // Calcular el rect√°ngulo del joystick base para posicionamiento
            joystickBaseRect = joystickBase.getBoundingClientRect();
            
            // Eventos para el joystick
            joystickBase.addEventListener('touchstart', handleJoystickStart);
            joystickBase.addEventListener('touchmove', handleJoystickMove);
            joystickBase.addEventListener('touchend', handleJoystickEnd);
            
            // Eventos para la c√°mara (rotaci√≥n por arrastrar)
            document.addEventListener('touchstart', handleTouchStart);
            document.addEventListener('touchmove', handleTouchMove);
            document.addEventListener('touchend', handleTouchEnd);
            
            // Configurar botones m√≥viles
            document.getElementById('mobile-message').addEventListener('touchstart', toggleScreen);
            document.getElementById('mobile-music').addEventListener('touchstart', toggleMusic);
            
            // Actualizar el joystick peri√≥dicamente
            setInterval(updateJoystickPosition, 20);
        }
        
        // Manejo del joystick
        function handleJoystickStart(event) {
            event.preventDefault();
            joystickActive = true;
            
            // Actualizar el rect√°ngulo por si ha cambiado
            joystickBaseRect = joystickBase.getBoundingClientRect();
            
            const touch = event.touches[0];
            const centerX = joystickBaseRect.left + joystickBaseRect.width / 2;
            const centerY = joystickBaseRect.top + joystickBaseRect.height / 2;
            
            // Mover el joystick al punto de toque
            updateJoystickThumb(touch.clientX, touch.clientY);
        }
        
        function handleJoystickMove(event) {
            if (!joystickActive) return;
            event.preventDefault();
            
            const touch = event.touches[0];
            updateJoystickThumb(touch.clientX, touch.clientY);
        }
        
        function handleJoystickEnd(event) {
            event.preventDefault();
            joystickActive = false;
            
            // Devolver el joystick a la posici√≥n central
            joystickThumb.style.transform = 'translate(-50%, -50%)';
            joystickPosition = { x: 0, y: 0 };
        }
        
        function updateJoystickThumb(clientX, clientY) {
            // Calcular la posici√≥n relativa al centro del joystick
            const centerX = joystickBaseRect.left + joystickBaseRect.width / 2;
            const centerY = joystickBaseRect.top + joystickBaseRect.height / 2;
            
            // Calcular la distancia desde el centro
            let deltaX = clientX - centerX;
            let deltaY = clientY - centerY;
            
            // Limitar el movimiento del joystick al radio del base
            const radius = joystickBaseRect.width / 2;
            const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
            
            if (distance > radius) {
                deltaX = deltaX * radius / distance;
                deltaY = deltaY * radius / distance;
            }
            
            // Actualizar la posici√≥n visual del thumb
            joystickThumb.style.transform = `translate(calc(-50% + ${deltaX}px), calc(-50% + ${deltaY}px))`;
            
            // Normalizar los valores para el movimiento (entre -1 y 1)
            joystickPosition = {
                x: deltaX / radius,
                y: deltaY / radius
            };
        }
        
        // Actualizar peri√≥dicamente la posici√≥n del joystick para el movimiento
        function updateJoystickPosition() {
            if (!isMobile) return;
            
            // Este valor se utilizar√° en updateCamera para mover al jugador
            window.joystickControls = {
                active: joystickActive,
                x: joystickPosition.x,
                y: -joystickPosition.y // Invertir Y para que arriba sea adelante
            };
        }
        
        // Manejo de la rotaci√≥n de la c√°mara por toque
        function handleTouchStart(event) {
            // Ignorar si el toque es dentro del joystick
            if (event.target.closest('.joystick-container') || 
                event.target.closest('.mobile-buttons')) {
                return;
            }
            
            isTouching = true;
            touchStartX = event.touches[0].clientX;
            touchStartY = event.touches[0].clientY;
        }
        
        function handleTouchMove(event) {
            // Ignorar si el toque es dentro del joystick
            if (!isTouching || event.target.closest('.joystick-container') || 
                event.target.closest('.mobile-buttons')) {
                return;
            }
            
            touchMoveX = event.touches[0].clientX - touchStartX;
            touchMoveY = event.touches[0].clientY - touchStartY;
            
            // Actualizar la rotaci√≥n de la c√°mara
            targetRotationX -= touchMoveX * 0.01;
            targetRotationY = Math.max(-Math.PI/4, Math.min(Math.PI/4, targetRotationY - touchMoveY * 0.01));
            
            // Actualizar los puntos de inicio para el pr√≥ximo movimiento
            touchStartX = event.touches[0].clientX;
            touchStartY = event.touches[0].clientY;
        }
        
        function handleTouchEnd(event) {
            isTouching = false;
        }
        
        // Configuraci√≥n para controles de escritorio (mantener igual)
        function setupDesktopControls() {
            // Variables para el control de la c√°mara con el rat√≥n
            let isMouseDown = false;
            let mouseX = 0;
            let mouseY = 0;
            
            // Variables para el movimiento con teclado
            const keys = {
                w: false,
                a: false,
                s: false,
                d: false
            };
            
            // Eventos de rat√≥n
            document.addEventListener('mousedown', (event) => {
                isMouseDown = true;
                mouseX = event.clientX;
                mouseY = event.clientY;
            });
            
            document.addEventListener('mouseup', () => {
                isMouseDown = false;
            });
            
            document.addEventListener('mousemove', (event) => {
                if (isMouseDown) {
                    const deltaX = event.clientX - mouseX;
                    const deltaY = event.clientY - mouseY;
                    
                    mouseX = event.clientX;
                    mouseY = event.clientY;
                    
                    targetRotationX -= deltaX * 0.01;
                    targetRotationY = Math.max(-Math.PI/4, Math.min(Math.PI/4, targetRotationY - deltaY * 0.01));
                }
            });
            
            // Eventos de teclado
            document.addEventListener('keydown', (event) => {
                switch (event.key.toLowerCase()) {
                    case 'w': keys.w = true; break;
                    case 'a': keys.a = true; break;
                    case 's': keys.s = true; break;
                    case 'd': keys.d = true; break;
                }
            });
            
            document.addEventListener('keyup', (event) => {
                switch (event.key.toLowerCase()) {
                    case 'w': keys.w = false; break;
                    case 'a': keys.a = false; break;
                    case 's': keys.s = false; break;
                    case 'd': keys.d = false; break;
                }
            });
            
            // Guardar las teclas en window para poder acceder desde updateCamera
            window.keys = keys;
        }
        
        // Variables para la rotaci√≥n de la c√°mara
        let targetRotationX = 0;
        let targetRotationY = 0;
        let currentRotationX = 0;
        let currentRotationY = 0;
        
        // Funci√≥n mejorada para actualizar la c√°mara (compatible con ambos controles)
        window.updateCamera = function(delta) {
            // Suavizar la rotaci√≥n
            currentRotationX += (targetRotationX - currentRotationX) * 0.1;
            currentRotationY += (targetRotationY - currentRotationY) * 0.1;
            
            // Aplicar rotaci√≥n
            camera.rotation.order = 'YXZ';
            camera.rotation.y = currentRotationX;
            camera.rotation.x = currentRotationY;
            
            // Movimiento basado en el input
            const speed = 10 * delta;
            const direction = new THREE.Vector3();
            
            // Obtener la direcci√≥n frontal (excluir el componente Y para mantener el movimiento en el plano horizontal)
            const frontVector = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
            frontVector.y = 0;
            frontVector.normalize();
            
            // Obtener la direcci√≥n lateral
            const rightVector = new THREE.Vector3(1, 0, 0).applyQuaternion(camera.quaternion);
            rightVector.y = 0;
            rightVector.normalize();
            
            if (isMobile && window.joystickControls && window.joystickControls.active) {
                // Movimiento basado en joystick
                const joyY = window.joystickControls.y;
                const joyX = window.joystickControls.x;
                
                if (Math.abs(joyY) > 0.1) {
                    direction.addScaledVector(frontVector, joyY);
                }
                
                if (Math.abs(joyX) > 0.1) {
                    direction.addScaledVector(rightVector, joyX);
                }
            } else if (!isMobile && window.keys) {
                // Movimiento basado en teclado
                if (window.keys.w) direction.add(frontVector);
                if (window.keys.s) direction.sub(frontVector);
                if (window.keys.a) direction.sub(rightVector);
                if (window.keys.d) direction.add(rightVector);
            }
            
            // Normalizar la direcci√≥n si hay movimiento
            if (direction.length() > 0) {
                direction.normalize();
                camera.position.addScaledVector(direction, speed);
                
                // Limitar el movimiento dentro de un √°rea
                camera.position.x = Math.max(-50, Math.min(50, camera.position.x));
                camera.position.z = Math.max(-50, Math.min(50, camera.position.z));
                
                // Mantener la altura
                camera.position.y = 5;
            }
        };
        
        // Resto del c√≥digo existente (mantener igual)
        // setupScreenControls, createDigitalScreen, toggleScreen, toggleMusic, etc.
        // No se incluyen para brevedad, mantener como en el original
        
        // Iniciar todo cuando se carga la p√°gina
        window.onload = function() {
            init();
            
            // Forzar la activaci√≥n del modo m√≥vil si es necesario
            if (isMobile) {
                console.log("Detectado dispositivo m√≥vil, activando controles t√°ctiles");
                setupMobileControls();
            }
            
            // Mostrar mensaje principal despu√©s de cargar
            setTimeout(() => {
                document.getElementById("myModal").style.display = "block";
            }, 2500);
            
            // Auto-mostrar la pantalla digital despu√©s de cerrar el modal
            setTimeout(() => {
                if (!isScreenVisible) {
                    toggleScreen();
                }
            }, 5000);
        };
        
        // Asegurarse de bloquear los gestos predeterminados en pantallas t√°ctiles
        document.addEventListener('touchmove', function(e) {
            if (e.target.closest('canvas')) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>